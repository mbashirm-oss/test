<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boron Shell - Offline Mode</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fdf6e3;
      color: #333;
      padding: 20px;
    }
    h1 {
      color: #5c3d99;
    }
    input, textarea, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
      font-size: 1em;
    }
    iframe {
      width: 100%;
      height: 300px;
      border: 2px solid #ccc;
      margin-top: 10px;
    }
    .logBox {
      background: #fff;
      border: 2px dashed #ccc;
      padding: 10px;
      margin-top: 10px;
      height: 150px;
      overflow-y: auto;
    }
    .storeList button {
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <h1>ğŸ§ª Boron Shell: Offline Mode</h1>

  <label for="url">ğŸŒ URL or Snapshot Key</label>
  <input type="text" id="url" placeholder="Enter URL or snapshot name" />

  <label for="html">ğŸ“„ Paste HTML (optional)</label>
  <textarea id="html" rows="6" placeholder="Paste raw HTML here..."></textarea>

  <button id="btn-fetch">ğŸ” Fetch & Render</button>
  <button id="btn-save">ğŸ’¾ Save Snapshot</button>
  <button id="btn-load">ğŸ“‚ Load Snapshot</button>
  <button id="btn-clear">ğŸ—‘ï¸ Delete Snapshot</button>

  <h2>ğŸ“º Preview</h2>
  <iframe id="preview"></iframe>

  <h2>ğŸ““ Devlog</h2>
  <div id="logBox" class="logBox"></div>

  <h2>ğŸ—‚ï¸ Stored Snapshots</h2>
  <div id="storeList" class="storeList"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (msg) => {
      const entry = document.createElement('div');
      entry.textContent = 'ğŸ§¸ ' + msg;
      $('logBox').appendChild(entry);
    };

    const sanitize = (html) => html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
    const storeKey = (key) => `boron:snapshot:${key}`;
    const render = (wrapped, base) => $('preview').srcdoc = wrapped;

    window.addEventListener('message', async (ev) => {
      if (!ev.data || ev.data.type !== 'boron:navigate') return;
      const href = ev.data.href;
      const base = $('url').value || '';
      const nextUrl = new URL(href, base).toString();
      $('url').value = nextUrl;
      log('Navigate request: ' + nextUrl);
      try {
        const res = await fetch(nextUrl, { mode: 'cors' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const text = await res.text();
        const safe = sanitize(text);
        render(safe, nextUrl);
        log('Fetched and rendered: ' + nextUrl);
      } catch (err) {
        log('Fetch blocked or failed: ' + err.message);
      }
    });

    $('btn-fetch').addEventListener('click', async () => {
      const url = $('url').value.trim();
      if (!url) return log('No URL provided.');
      log('Attempting fetch: ' + url);
      try {
        const res = await fetch(url, { mode: 'cors' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const text = await res.text();
        const safe = sanitize(text);
        render(safe, url);
        log('Fetched and rendered: ' + url);
      } catch (err) {
        log('Fetch blocked or failed: ' + err.message + ' â€” paste HTML instead.');
      }
    });

    $('btn-save').addEventListener('click', () => {
      const key = ($('url').value.trim() || 'snapshot').toLowerCase();
      const html = $('html').value;
      if (!html) return log('Nothing to save. Paste HTML first.');
      const safe = sanitize(html);
      localStorage.setItem(storeKey(key), JSON.stringify({ html: safe, base: $('url').value.trim() }));
      listStore();
      log('Saved snapshot under key: ' + key);
    });

    $('btn-load').addEventListener('click', () => {
      const key = ($('url').value.trim() || 'snapshot').toLowerCase();
      const raw = localStorage.getItem(storeKey(key));
      if (!raw) return log('No snapshot found for key: ' + key);
      const { html, base } = JSON.parse(raw);
      render(html, base || '');
      log('Loaded snapshot: ' + key);
    });

    $('btn-clear').addEventListener('click', () => {
      const key = ($('url').value.trim() || 'snapshot').toLowerCase();
      localStorage.removeItem(storeKey(key));
      listStore();
      log('Deleted snapshot: ' + key);
    });

    $('storeList').addEventListener('click', (e) => {
      const load = e.target.getAttribute('data-load');
      const del = e.target.getAttribute('data-del');
      const name = e.target.getAttribute('data-name');
      if (name) $('url').value = name;
      if (load) {
        $('url').value = load;
        $('btn-load').click();
      } else if (del) {
        $('url').value = del;
        $('btn-clear').click();
      }
    });

    function listStore() {
      const container = $('storeList');
      container.innerHTML = '';
      Object.keys(localStorage).forEach((key) => {
        if (!key.startsWith('boron:snapshot:')) return;
        const name = key.replace('boron:snapshot:', '');
        const btnLoad = document.createElement('button');
        btnLoad.textContent = 'ğŸ“‚ ' + name;
        btnLoad.setAttribute('data-load', name);
        btnLoad.setAttribute('data-name', name);

        const btnDel = document.createElement('button');
        btnDel.textContent = 'ğŸ—‘ï¸';
        btnDel.setAttribute('data-del', name);

        container.appendChild(btnLoad);
        container.appendChild(btnDel);
      });
    }

    // Initialize
    listStore();
    render('');
  </script>

</body>
</html>
